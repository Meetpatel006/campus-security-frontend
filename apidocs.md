# Campus Safety Monitoring System API Documentation

## Overview

The Campus Safety Monitoring System provides a comprehensive API for real-time video surveillance, anomaly detection, and alert management. Built with FastAPI and deployed on Modal, it offers scalable monitoring capabilities for campus security applications.

**Base URL**: `https://your-modal-app-url.modal.run`  
**API Version**: 1.0.0  
**Framework**: FastAPI with Modal deployment  

## Authentication

Currently, the API does not require authentication. All endpoints are publicly accessible.

---

## Table of Contents

1. [System Overview](#system-overview)
2. [Data Models](#data-models)
3. [API Endpoints](#api-endpoints)
   - [System Status](#system-status)
   - [Camera Management](#camera-management)
   - [Alert Management](#alert-management)
   - [Monitoring Control](#monitoring-control)
   - [Anomaly Detection](#anomaly-detection)
4. [Error Handling](#error-handling)
5. [Usage Examples](#usage-examples)
6. [Integration Guide](#integration-guide)

---

## System Overview

The Campus Safety API provides the following core functionalities:

- **Real-time Video Monitoring**: Manage multiple camera sources
- **Anomaly Detection**: AI-powered detection of unusual activities
- **Alert Management**: Create, retrieve, and manage security alerts
- **System Control**: Start/stop monitoring and check system health

### Key Features

- Multi-camera support with dynamic camera addition
- Real-time frame processing and anomaly detection
- Comprehensive alert system with severity levels
- RESTful API design with JSON responses
- CORS enabled for web application integration

---

## Data Models

### Camera

Represents a camera source in the monitoring system.

```json
{
  "id": 0,
  "source": "string",
  "status": "string",
  "name": "string"
}
```

**Fields:**
- `id` (integer): Unique camera identifier
- `source` (string): Camera source (URL, device index, or file path)
- `status` (string): Current camera status (`active`, `inactive`, `error`)
- `name` (string, optional): Human-readable camera name

### CameraCreate

Request model for adding new cameras.

```json
{
  "source": "string",
  "name": "string"
}
```

**Fields:**
- `source` (string, required): Camera source identifier
- `name` (string, optional): Display name for the camera

### Alert

Represents a security alert generated by the system.

```json
{
  "id": 0,
  "type": "string",
  "description": "string",
  "camera_id": 0,
  "timestamp": "2025-09-01T12:00:00Z",
  "severity": "string",
  "status": "string",
  "location": "string"
}
```

**Fields:**
- `id` (integer): Unique alert identifier
- `type` (string): Alert category (e.g., "Fighting", "Vandalism", "Suspicious_Activity")
- `description` (string): Detailed alert description
- `camera_id` (integer): ID of the camera that triggered the alert
- `timestamp` (datetime): When the alert was created
- `severity` (string): Alert severity (`low`, `medium`, `high`, `critical`)
- `status` (string): Alert status (`active`, `acknowledged`, `resolved`)
- `location` (string, optional): Physical location description

### AlertCreate

Request model for creating new alerts.

```json
{
  "type": "string",
  "description": "string",
  "camera_id": 0,
  "severity": "string",
  "location": "string"
}
```

### MonitoringStatus

System status information.

```json
{
  "status": "string",
  "active_cameras": 0,
  "alerts_count": 0,
  "system_health": "string"
}
```

**Fields:**
- `status` (string): Overall system status (`running`, `stopped`, `error`)
- `active_cameras` (integer): Number of currently active cameras
- `alerts_count` (integer): Total number of alerts
- `system_health` (string): System health indicator (`healthy`, `warning`, `critical`)

### VideoFrame

Frame data for anomaly detection.

```json
{
  "camera_id": 0,
  "frame_data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABA...",
  "timestamp": "2025-09-01T12:00:00Z"
}
```

**Fields:**
- `camera_id` (integer): Source camera identifier
- `frame_data` (string): Base64-encoded image data with MIME type prefix
- `timestamp` (datetime): Frame capture timestamp

### DetectionResult

Result of anomaly detection analysis.

```json
{
  "camera_id": 0,
  "is_anomaly": true,
  "detected_class": "Fighting",
  "confidence": 0.85,
  "timestamp": "2025-09-01T12:00:00Z",
  "details": {}
}
```

**Fields:**
- `camera_id` (integer): Source camera identifier
- `is_anomaly` (boolean): Whether an anomaly was detected
- `detected_class` (string): Classification of detected activity
- `confidence` (float): Detection confidence score (0.0-1.0)
- `timestamp` (datetime): Detection timestamp
- `details` (object): Additional detection metadata

---

## API Endpoints

### System Status

#### GET /

Get basic system information and status.

**Response:**
```json
{
  "message": "Welcome to Campus Safety Monitoring System API",
  "version": "1.0.0",
  "status": "running"
}
```

**Status Codes:**
- `200 OK`: System is operational

---

### Camera Management

#### GET /api/cameras

Retrieve all registered cameras.

**Response:**
```json
[
  {
    "id": 0,
    "source": "0",
    "status": "active",
    "name": "Camera 0"
  },
  {
    "id": 1,
    "source": "http://192.168.1.100/stream",
    "status": "inactive",
    "name": "Main Entrance"
  }
]
```

**Status Codes:**
- `200 OK`: Successfully retrieved cameras
- `500 Internal Server Error`: System error

#### POST /api/cameras

Add a new camera to the monitoring system.

**Request Body:**
```json
{
  "source": "http://192.168.1.101/stream",
  "name": "Library Entrance"
}
```

**Response:**
```json
{
  "id": 2,
  "source": "http://192.168.1.101/stream",
  "status": "inactive",
  "name": "Library Entrance"
}
```

**Status Codes:**
- `200 OK`: Camera added successfully
- `500 Internal Server Error`: Failed to add camera

---

### Alert Management

#### GET /api/alerts

Retrieve all system alerts.

**Response:**
```json
[
  {
    "id": 1,
    "type": "Fighting",
    "description": "Anomaly detected: Fighting",
    "camera_id": 0,
    "timestamp": "2025-09-01T12:00:00Z",
    "severity": "high",
    "status": "active",
    "location": "Main Courtyard"
  }
]
```

**Status Codes:**
- `200 OK`: Successfully retrieved alerts
- `500 Internal Server Error`: System error

#### POST /api/alerts

Create a new alert manually.

**Request Body:**
```json
{
  "type": "Suspicious_Activity",
  "description": "Unauthorized access attempt detected",
  "camera_id": 1,
  "severity": "medium",
  "location": "Main Entrance"
}
```

**Response:**
```json
{
  "id": 2,
  "type": "Suspicious_Activity",
  "description": "Unauthorized access attempt detected",
  "camera_id": 1,
  "timestamp": "2025-09-01T12:05:00Z",
  "severity": "medium",
  "status": "active",
  "location": "Main Entrance"
}
```

**Status Codes:**
- `200 OK`: Alert created successfully
- `500 Internal Server Error`: Failed to create alert

---

### Monitoring Control

#### GET /api/monitoring/status

Get current monitoring system status.

**Response:**
```json
{
  "status": "running",
  "active_cameras": 3,
  "alerts_count": 5,
  "system_health": "healthy"
}
```

**Status Codes:**
- `200 OK`: Status retrieved successfully
- `500 Internal Server Error`: System error

#### POST /api/monitoring/start

Start the monitoring system.

**Response:**
```json
{
  "message": "Monitoring system started successfully"
}
```

**Status Codes:**
- `200 OK`: Monitoring started successfully
- `500 Internal Server Error`: Failed to start monitoring

#### POST /api/monitoring/stop

Stop the monitoring system.

**Response:**
```json
{
  "message": "Monitoring system stopped successfully"
}
```

**Status Codes:**
- `200 OK`: Monitoring stopped successfully
- `500 Internal Server Error`: Failed to stop monitoring

---

### Anomaly Detection

#### POST /api/detect/frame

Process a single video frame for anomaly detection.

**Request Body:**
```json
{
  "camera_id": 0,
  "frame_data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD...",
  "timestamp": "2025-09-01T12:00:00Z"
}
```

**Response:**
```json
{
  "camera_id": 0,
  "is_anomaly": true,
  "detected_class": "Fighting",
  "confidence": 0.87,
  "timestamp": "2025-09-01T12:00:05Z",
  "details": {
    "final_confidence": 0.87,
    "processing_time": 0.234,
    "model_version": "v2.1"
  }
}
```

**Status Codes:**
- `200 OK`: Frame processed successfully
- `500 Internal Server Error`: Processing error

**Notes:**
- Frame data must be base64-encoded with proper MIME type prefix
- The system requires 16 frames in buffer before running detection
- Anomalies with confidence > 0.8 automatically create high-severity alerts

---

## Error Handling

### Error Response Format

All API errors return a standardized JSON format:

```json
{
  "detail": "Error description"
}
```

### Common HTTP Status Codes

- `200 OK`: Request successful
- `400 Bad Request`: Invalid request data
- `404 Not Found`: Resource not found
- `422 Unprocessable Entity`: Validation error
- `500 Internal Server Error`: Server error

### Error Types

#### Validation Errors
Occur when request data doesn't match expected schema:
```json
{
  "detail": [
    {
      "loc": ["body", "camera_id"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

#### System Errors
Internal server errors with descriptive messages:
```json
{
  "detail": "Failed to initialize camera: Invalid source"
}
```

---

## Usage Examples

### Python Client Example

```python
import requests
import base64
import json
from datetime import datetime

class CampusSafetyClient:
    def __init__(self, base_url):
        self.base_url = base_url.rstrip('/')
    
    def get_status(self):
        """Get system status"""
        response = requests.get(f"{self.base_url}/api/monitoring/status")
        return response.json()
    
    def add_camera(self, source, name=None):
        """Add a new camera"""
        data = {"source": source}
        if name:
            data["name"] = name
        
        response = requests.post(f"{self.base_url}/api/cameras", json=data)
        return response.json()
    
    def create_alert(self, alert_type, description, camera_id, severity, location=None):
        """Create a new alert"""
        data = {
            "type": alert_type,
            "description": description,
            "camera_id": camera_id,
            "severity": severity
        }
        if location:
            data["location"] = location
        
        response = requests.post(f"{self.base_url}/api/alerts", json=data)
        return response.json()
    
    def detect_frame(self, camera_id, image_path):
        """Process image file for anomaly detection"""
        with open(image_path, 'rb') as f:
            image_data = base64.b64encode(f.read()).decode()
        
        frame_data = f"data:image/jpeg;base64,{image_data}"
        data = {
            "camera_id": camera_id,
            "frame_data": frame_data,
            "timestamp": datetime.now().isoformat()
        }
        
        response = requests.post(f"{self.base_url}/api/detect/frame", json=data)
        return response.json()

# Usage
client = CampusSafetyClient("https://your-app-url.modal.run")

# Check system status
status = client.get_status()
print(f"System status: {status['status']}")

# Add a camera
camera = client.add_camera("http://192.168.1.100/stream", "Main Gate")
print(f"Added camera: {camera['id']}")

# Create an alert
alert = client.create_alert(
    alert_type="Suspicious_Activity",
    description="Person loitering near entrance",
    camera_id=0,
    severity="medium",
    location="Main Entrance"
)
print(f"Created alert: {alert['id']}")
```

### JavaScript/Node.js Example

```javascript
class CampusSafetyAPI {
    constructor(baseUrl) {
        this.baseUrl = baseUrl.replace(/\/$/, '');
    }

    async request(endpoint, options = {}) {
        const url = `${this.baseUrl}${endpoint}`;
        const response = await fetch(url, {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
        
        return response.json();
    }

    async getStatus() {
        return this.request('/api/monitoring/status');
    }

    async getCameras() {
        return this.request('/api/cameras');
    }

    async addCamera(source, name = null) {
        return this.request('/api/cameras', {
            method: 'POST',
            body: JSON.stringify({ source, name })
        });
    }

    async getAlerts() {
        return this.request('/api/alerts');
    }

    async startMonitoring() {
        return this.request('/api/monitoring/start', { method: 'POST' });
    }

    async stopMonitoring() {
        return this.request('/api/monitoring/stop', { method: 'POST' });
    }
}

// Usage
const api = new CampusSafetyAPI('https://your-app-url.modal.run');

// Get system status
api.getStatus().then(status => {
    console.log('System Status:', status);
});

// Start monitoring
api.startMonitoring().then(result => {
    console.log('Monitoring started:', result.message);
});
```

### cURL Examples

#### Get System Status
```bash
curl -X GET "https://your-app-url.modal.run/api/monitoring/status" \
  -H "accept: application/json"
```

#### Add a Camera
```bash
curl -X POST "https://your-app-url.modal.run/api/cameras" \
  -H "accept: application/json" \
  -H "Content-Type: application/json" \
  -d '{
    "source": "http://192.168.1.100/stream",
    "name": "Main Entrance Camera"
  }'
```

#### Create an Alert
```bash
curl -X POST "https://your-app-url.modal.run/api/alerts" \
  -H "accept: application/json" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "Suspicious_Activity",
    "description": "Unauthorized access detected",
    "camera_id": 0,
    "severity": "high",
    "location": "Building A Entrance"
  }'
```

#### Start Monitoring
```bash
curl -X POST "https://your-app-url.modal.run/api/monitoring/start" \
  -H "accept: application/json"
```

---

## Integration Guide

### Web Application Integration

#### Real-time Dashboard
```html
<!DOCTYPE html>
<html>
<head>
    <title>Campus Safety Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div id="dashboard">
        <div id="status"></div>
        <div id="cameras"></div>
        <div id="alerts"></div>
    </div>

    <script>
        class Dashboard {
            constructor(apiUrl) {
                this.apiUrl = apiUrl;
                this.init();
            }

            async init() {
                await this.updateStatus();
                await this.updateCameras();
                await this.updateAlerts();
                
                // Refresh every 5 seconds
                setInterval(() => {
                    this.updateStatus();
                    this.updateAlerts();
                }, 5000);
            }

            async updateStatus() {
                try {
                    const response = await fetch(`${this.apiUrl}/api/monitoring/status`);
                    const status = await response.json();
                    
                    document.getElementById('status').innerHTML = `
                        <h3>System Status</h3>
                        <p>Status: ${status.status}</p>
                        <p>Active Cameras: ${status.active_cameras}</p>
                        <p>Total Alerts: ${status.alerts_count}</p>
                        <p>Health: ${status.system_health}</p>
                    `;
                } catch (error) {
                    console.error('Failed to update status:', error);
                }
            }

            async updateCameras() {
                try {
                    const response = await fetch(`${this.apiUrl}/api/cameras`);
                    const cameras = await response.json();
                    
                    const camerasHtml = cameras.map(camera => `
                        <div class="camera">
                            <h4>${camera.name || 'Camera ' + camera.id}</h4>
                            <p>Source: ${camera.source}</p>
                            <p>Status: ${camera.status}</p>
                        </div>
                    `).join('');
                    
                    document.getElementById('cameras').innerHTML = `
                        <h3>Cameras</h3>
                        ${camerasHtml}
                    `;
                } catch (error) {
                    console.error('Failed to update cameras:', error);
                }
            }

            async updateAlerts() {
                try {
                    const response = await fetch(`${this.apiUrl}/api/alerts`);
                    const alerts = await response.json();
                    
                    const alertsHtml = alerts.map(alert => `
                        <div class="alert alert-${alert.severity}">
                            <h4>${alert.type}</h4>
                            <p>${alert.description}</p>
                            <p>Camera: ${alert.camera_id}</p>
                            <p>Time: ${new Date(alert.timestamp).toLocaleString()}</p>
                            <p>Severity: ${alert.severity}</p>
                        </div>
                    `).join('');
                    
                    document.getElementById('alerts').innerHTML = `
                        <h3>Recent Alerts</h3>
                        ${alertsHtml}
                    `;
                } catch (error) {
                    console.error('Failed to update alerts:', error);
                }
            }
        }

        // Initialize dashboard
        const dashboard = new Dashboard('https://your-app-url.modal.run');
    </script>

    <style>
        .alert { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .alert-high { background-color: #ffebee; border-left: 4px solid #f44336; }
        .alert-medium { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .alert-low { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
        .camera { margin: 10px 0; padding: 10px; background-color: #f5f5f5; }
    </style>
</body>
</html>
```

### Mobile App Integration

#### React Native Example
```javascript
import React, { useState, useEffect } from 'react';
import { View, Text, FlatList, Alert } from 'react-native';

const CampusSafetyApp = () => {
    const [status, setStatus] = useState(null);
    const [alerts, setAlerts] = useState([]);
    const API_URL = 'https://your-app-url.modal.run';

    useEffect(() => {
        fetchStatus();
        fetchAlerts();
        
        const interval = setInterval(() => {
            fetchStatus();
            fetchAlerts();
        }, 10000); // Update every 10 seconds

        return () => clearInterval(interval);
    }, []);

    const fetchStatus = async () => {
        try {
            const response = await fetch(`${API_URL}/api/monitoring/status`);
            const data = await response.json();
            setStatus(data);
        } catch (error) {
            console.error('Failed to fetch status:', error);
        }
    };

    const fetchAlerts = async () => {
        try {
            const response = await fetch(`${API_URL}/api/alerts`);
            const data = await response.json();
            setAlerts(data);
        } catch (error) {
            console.error('Failed to fetch alerts:', error);
        }
    };

    const renderAlert = ({ item }) => (
        <View style={styles.alertItem}>
            <Text style={styles.alertType}>{item.type}</Text>
            <Text>{item.description}</Text>
            <Text>Camera: {item.camera_id}</Text>
            <Text>Severity: {item.severity}</Text>
            <Text>{new Date(item.timestamp).toLocaleString()}</Text>
        </View>
    );

    return (
        <View style={styles.container}>
            <Text style={styles.title}>Campus Safety Monitor</Text>
            
            {status && (
                <View style={styles.statusContainer}>
                    <Text>Status: {status.status}</Text>
                    <Text>Active Cameras: {status.active_cameras}</Text>
                    <Text>Total Alerts: {status.alerts_count}</Text>
                </View>
            )}

            <FlatList
                data={alerts}
                keyExtractor={(item) => item.id.toString()}
                renderItem={renderAlert}
                style={styles.alertsList}
            />
        </View>
    );
};

const styles = {
    container: { flex: 1, padding: 20 },
    title: { fontSize: 24, fontWeight: 'bold', marginBottom: 20 },
    statusContainer: { marginBottom: 20, padding: 10, backgroundColor: '#f0f0f0' },
    alertsList: { flex: 1 },
    alertItem: { padding: 10, marginBottom: 10, backgroundColor: '#fff', borderRadius: 5 },
    alertType: { fontSize: 16, fontWeight: 'bold' }
};

export default CampusSafetyApp;
```

### Webhook Integration

For real-time notifications, you can implement a webhook system:

```python
# Example webhook handler
from flask import Flask, request
import requests

app = Flask(__name__)

@app.route('/webhook/alerts', methods=['POST'])
def handle_alert():
    alert_data = request.json
    
    # Process the alert
    if alert_data['severity'] == 'high':
        # Send immediate notification
        send_emergency_notification(alert_data)
    
    # Log to database
    log_alert_to_database(alert_data)
    
    return {'status': 'received'}

def send_emergency_notification(alert):
    # Implementation for emergency notifications
    # (email, SMS, push notifications, etc.)
    pass
```

---

## Rate Limiting

Currently, there are no explicit rate limits set on the API. However, consider implementing reasonable usage patterns:

- **Status checks**: Maximum once per second
- **Alert retrieval**: Maximum once per 5 seconds
- **Frame detection**: Limited by processing capacity
- **Camera management**: As needed

---

## Security Considerations

### Current Security Status
- No authentication required
- CORS enabled for all origins
- All endpoints publicly accessible

### Recommended Security Enhancements
1. **API Key Authentication**: Implement API key-based authentication
2. **Rate Limiting**: Add request rate limiting
3. **CORS Configuration**: Restrict CORS to specific domains
4. **Input Validation**: Enhanced validation for all inputs
5. **Audit Logging**: Log all API requests and responses

### Example Security Implementation
```python
from fastapi import HTTPException, Depends, Header

async def verify_api_key(x_api_key: str = Header()):
    if x_api_key != "your-secret-api-key":
        raise HTTPException(status_code=401, detail="Invalid API key")
    return x_api_key

# Add to endpoints
@web_app.get("/api/cameras", dependencies=[Depends(verify_api_key)])
async def get_cameras():
    # ... existing code
```

---

## Support and Troubleshooting

### Common Issues

#### 1. Camera Connection Failures
- Verify camera source URL/index
- Check network connectivity
- Ensure proper permissions

#### 2. Detection Performance Issues
- Monitor system resources
- Adjust frame buffer size
- Optimize image resolution

#### 3. API Response Timeouts
- Check Modal function timeout settings
- Monitor system load
- Consider async processing for heavy operations

### Debug Endpoints

Add these endpoints for debugging:

```python
@web_app.get("/debug/health")
async def debug_health():
    return {
        "timestamp": datetime.now(),
        "system_info": {
            "cameras": len(safety_system.get_cameras()),
            "monitoring": safety_system.is_monitoring,
            "memory_usage": "N/A"  # Add actual memory monitoring
        }
    }
```

### Contact Information

For technical support or questions:
- GitHub Issues: [Create an issue](https://github.com/your-repo/campus-safety)
- Email: support@campussafety.example
- Documentation: [Online Documentation](https://docs.campussafety.example)

---

## Changelog

### Version 1.0.0 (Current)
- Initial API release
- Camera management endpoints
- Alert system implementation
- Anomaly detection integration
- Real-time monitoring capabilities

### Planned Features
- WebSocket support for real-time updates
- Enhanced authentication system
- Batch processing endpoints
- Historical data analytics
- Mobile push notifications
- Advanced filtering and search

---

This documentation provides comprehensive coverage of the Campus Safety Monitoring System API. For the most up-to-date information, please refer to the interactive API documentation available at `https://your-app-url.modal.run/docs` when the application is deployed.
